This package loads rodent visual behavior experiments with associated neuropixels
data, including visualization and analysis tools.

The package also includes tools to automatically register neuropixels data
with histology, to align behavior and electrophysiological data based on shared
TTL signals, to parse outputs from RigBox Timeline and Block files in
a Pythonic manner, and to perform high-level analysis of the resulting outputs.

[The focus now is on loading Blake Russel's ReportOpto dataset and performing
analysis on it. Future work will make this more generalizable.]

## Installation

### Prerequisites
- Python 3.8 or higher
- conda or pip package manager

### Install from GitHub

1. **Clone the repository:**
```bash
git clone https://github.com/mbfl/npixloader.git
cd npixloader
```

2. **Install the package:**

For development (editable install, recommended):
```bash
pip install -e .
```

For standard installation:
```bash
pip install .
```

This will automatically install all required dependencies (numpy, scipy, matplotlib, pandas, scikit-learn, statsmodels, seaborn, tifffile, zetapy) and make command-line tools available.

3. **Verify installation:**
```python
import npixloader as npl
print(npl.__file__)  # Should print package location
```

Or test the command-line tool:
```bash
beh-check --help
```

## Main usage

This package can load behavioral data files generated by **RigBox** (Block.mat and Timeline.mat files), either standalone or in combination with simultaneously acquired neural recordings from Neuropixels or two-photon imaging.

```python
import npixloader as npl
```

### 1. Loading behavior data alone

For loading and parsing behavioral data from RigBox experiments without neural recordings:

```python
from npixloader.beh import BehDataSimpleLoad, BlockParser, TimelineParser

# Simple behavior loading with stimulus parsing
beh = BehDataSimpleLoad('/path/to/animal/date/folder',
                        parse_stims=True,
                        parse_by='stimulusOrientation')

# Access stimulus information
stim_times = beh.stim.t_start
stim_orientations = beh._stimparser.ori

# Low-level parsing of Block and Timeline files
block = BlockParser('/path/to/Block.mat')
timeline = TimelineParser('/path/to/Timeline.mat')
```


### 2. Loading behavior data and simultaneous neuropixels recording (load_exp.py)

For experiments with Neuropixels recordings and simultaneous behavior:

```python
# Load dataset metadata
dset = npl.DSetObj(path_reportopto='path_to_dataset.csv')

# Load a specific experiment (includes behavior, ephys, and alignment)
exp = npl.ExpObj_ReportOpto(dset_obj=dset, dset_ind=5)
exp.plt_exp()  # visualizes experiment

# Access components
exp.beh      # Behavior data
exp.ephys    # Neuropixels data (spike times, clusters, histology)
exp.aligner  # Alignment between behavior and ephys clocks
```
![plt_exp_output](/plt_exp_out.jpg)

For ValuePFC experiments:
```python
exp = npl.ExpObj_ValuePFC(dset_obj=dset, dset_ind=5)
```

### 3. Loading behavior data and simultaneous two-photon (2p) recording (load_exp_twop.py)

For experiments with two-photon calcium imaging and simultaneous behavior:

```python
from npixloader.load_exp_twop import TwoPRec

# Load two-photon recording with behavior
rec = TwoPRec(path='/path/to/animal/date/folder')

# Access components
rec.beh      # Behavior data
rec.img      # Two-photon imaging data (dF/F traces, ROIs)
rec.aligner  # Alignment between imaging and behavior clocks
```
	
	
## Analysis
- `npix_loader.analysis_fns` contains functions to load and plot entire datasets
comprised of many experiments.

```
import npixloader.analysis_fns as npl_analysis
```

  - `npl_analysis.ephys_all = get_ephys_all()` parses a dataset for all
  experiments containing recordings from
  a particular region
  - `npl_analysis.plt_ephys_all_ordered(ephys_all)` plots a stimulus- or
  choice-aligned raster of the subset of ephys recordings from `get_ephys_all`.
  This can include ordering by time or by relative activity.
  
## Command line tools

### beh-check: Behavioral Performance Visualization

Quick visualization tool for daily behavioral performance in **Pavlovian (classical conditioning) experiments only**. Plots licking behavior across trials, separated by trial type.

**Usage:**
```bash
# Basic usage
beh-check /path/to/behavior/folder

# With noise flag (for experiments with noisy lick detector signal)
beh-check /path/to/behavior/folder -n
```

**Output:** PDF figure with trial-by-trial licking rasters, smoothed average licking rates (aligned to stimulus and reward), and anticipatory licking histogram, all separated by trial type (e.g., stimulus orientations, reward probabilities). Saved to parent directory as `{animal}_{date}_{folder}_behavior_summary.pdf`.
